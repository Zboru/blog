<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Zboru</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/blog/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="preload" href="/blog/_nuxt/d3eef40.js" as="script"><link rel="preload" href="/blog/_nuxt/500acbd.js" as="script"><link rel="preload" href="/blog/_nuxt/145e282.js" as="script"><link rel="preload" href="/blog/_nuxt/8282d77.js" as="script"><link rel="preload" href="/blog/_nuxt/f12c784.js" as="script"><style data-vue-ssr-id="65b97e00:0 17bc9ac2:0 15f0552d:0 2ec07acc:0 b682ae5a:0">/*! tailwindcss v2.2.17 | MIT License | https://tailwindcss.com*//*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input:-ms-input-placeholder,textarea:-ms-input-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}*,::after,::before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.container{width:100%;margin-right:auto;margin-left:auto}@media (min-width:1200px){.container{max-width:1200px}}.static{position:static}.sticky{position:-webkit-sticky;position:sticky}.top-0{top:0}.z-10{z-index:10}.mx-2{margin-left:.5rem;margin-right:.5rem}.my-1{margin-top:.25rem;margin-bottom:.25rem}.mt-4{margin-top:1rem}.mb-8{margin-bottom:2rem}.flex{display:flex}.table{display:table}.h-6{height:1.5rem}.w-6{width:1.5rem}.w-5\/6{width:83.333333%}.w-full{width:100%}@-webkit-keyframes spin{to{transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}@-webkit-keyframes ping{100%,75%{transform:scale(2);opacity:0}}@keyframes ping{100%,75%{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,100%{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,100%{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}.cursor-pointer{cursor:pointer}.flex-col{flex-direction:column}.justify-between{justify-content:space-between}.bg-white{--tw-bg-opacity:1;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.dark .dark\:bg-primary{--tw-bg-opacity:1;background-color:rgba(15,15,15,var(--tw-bg-opacity))}.px-4{padding-left:1rem;padding-right:1rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.font-semibold{font-weight:600}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-indigo-600{--tw-text-opacity:1;color:rgba(79,70,229,var(--tw-text-opacity))}.dark .dark\:text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.dark .dark\:text-gray-200{--tw-text-opacity:1;color:rgba(229,231,235,var(--tw-text-opacity))}.dark .dark\:text-indigo-400{--tw-text-opacity:1;color:rgba(129,140,248,var(--tw-text-opacity))}*,::after,::before{--tw-shadow:0 0 #0000}*,::after,::before{--tw-ring-inset:var(--tw-empty, );/*!*//*!*/--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59, 130, 246, 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}@media (min-width:768px){.md\:w-1\/2{width:50%}.md\:w-3\/5{width:60%}.md\:bg-transparent{background-color:transparent}.dark .md\:dark\:bg-transparent{background-color:transparent}.md\:px-0{padding-left:0;padding-right:0}}body{font-family:"Space Grotesk",sans-serif}body.dark{background-color:#0f0f0f}.dark .post-background{background-color:#1e1e1e}.post-background{background-color:#f5f5f5}h1{margin-top:.5rem;font-size:1.875rem;line-height:2.25rem;font-weight:700}h2{margin-top:1rem;font-size:1.5rem;line-height:2rem;font-weight:700}p{margin-top:.5rem;margin-bottom:.5rem}em{font-style:italic}code{color:#eb5757;background:rgba(135,131,120,.15);padding:.25rem}ol li{margin-left:2rem;list-style-type:decimal}p>img{margin:0 auto;margin-top:1rem;margin-bottom:1rem}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:400;src:url(/blog/_nuxt/fonts/Space_Grotesk-400-vietnamese1.f57f7a9.woff2) format("woff2");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:400;src:url(/blog/_nuxt/fonts/Space_Grotesk-400-latin-ext2.2a30dd4.woff2) format("woff2");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:400;src:url(/blog/_nuxt/fonts/Space_Grotesk-400-latin3.607438a.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:600;src:url(/blog/_nuxt/fonts/Space_Grotesk-600-vietnamese4.f57f7a9.woff2) format("woff2");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:600;src:url(/blog/_nuxt/fonts/Space_Grotesk-600-latin-ext5.2a30dd4.woff2) format("woff2");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:"Space Grotesk";font-style:normal;font-weight:600;src:url(/blog/_nuxt/fonts/Space_Grotesk-600-latin6.607438a.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}</style><link rel="preload" href="/blog/_nuxt/static/1635189324/aws-ec2/state.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1635189324/aws-ec2/payload.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1635189324/manifest.js" as="script">
  </head>
  <body class="dark" data-n-head="%7B%22class%22:%7B%22ssr%22:%22dark%22%7D%7D">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="dark:text-white"><div class="flex sticky top-0 justify-between py-4 px-4 bg-white md:bg-transparent dark:bg-primary md:dark:bg-transparent z-10 md:px-0 container"><a href="/blog/" class="font-semibold text-xl text-indigo-600 dark:text-indigo-400 nuxt-link-active">Zboru</a> <div><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 256" class="iconify iconify--ph w-6 h-6 cursor-pointer dark:text-white"><path d="M248 88a8 8 0 0 1-8 8h-16v16a8 8 0 0 1-16 0V96h-16a8 8 0 0 1 0-16h16V64a8 8 0 0 1 16 0v16h16a8 8 0 0 1 8 8zm-96-40h8v8a8 8 0 0 0 16 0v-8h8a8 8 0 0 0 0-16h-8v-8a8 8 0 0 0-16 0v8h-8a8 8 0 0 0 0 16zm64.457 96.65a7.985 7.985 0 0 0-2.156.352A84.031 84.031 0 0 1 111.015 41.638a8.002 8.002 0 0 0-9.965-9.962a100.014 100.014 0 1 0 123.29 123.221a8.001 8.001 0 0 0-7.883-10.248z" fill="currentColor"></path></svg> <!----></div></div> <div class="dark:text-white"><h1 class="text-4xl mb-8 container w-5/6 md:w-1/2">JavaScript heap out of memory - kompilacja projektu na EC2 AWS</h1> <div class="post-background"><div class="container py-4 w-5/6 md:w-1/2"><div class="nuxt-content"><h1 id="tldr-dodaj-swap-do-instancji"><a href="#tldr-dodaj-swap-do-instancji" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><em>TL:DR dodaj SWAP do instancji</em></h1>
<p>Niejednemu z nas mogło zdarzyć się spróbować <em>'zbudować'</em> projekt na instancji EC2, a dokładniej na t2.micro, czyli tej najsłabszej, darmowej. Być może wszystko przeszło pomyślnie i projekt skompilował się poprawnie, a może jednak natrafiłeś na problem związany z brakiem pamięci, a dokładniej <code>FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory</code>.</p>
<p><img alt="Out of memory" src="/blog/images/articles/ec2-swap/out_of_memory.png"></p>
<p>Wywołanie błędu próbując skompilować projekt używając Laravel Mix</p>
<p>Jednym z rozwiązań w tej sytuacji jest dodanie pamięci SWAP do naszej instancji oraz pozwolenie Node.js jej użycie. Wiadomo, są inne rozwiązania takie jak:</p>
<ol>
<li>Użycie mocniejszego typu instancji, z większą ilością pamięci RAM</li>
<li>Kompilowanie projektu na lokalnym środowisku i przesłanie plików na serwer</li>
</ol>
<p>O ile rozwiązanie nr.1 jest w porządku, tak <u>wymaga ono wyjścia z darmowej oferty</u>. Co do rozwiązania pod punktem 2, jest ono niewskazane ze względu na dyskomfort i ogólny błąd w sztuce. W czasach, gdy obecne są rozwiązania CI/CD nie możemy sobie pozwolić, aby nasz projekt nie kompilował się na serwerze docelowym.</p>
<h2 id="krok-1-utwórz-nowy-wolumen-ebs"><a href="#krok-1-utw%C3%B3rz-nowy-wolumen-ebs" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Krok 1. Utwórz nowy wolumen EBS</h2>
<p>Zaloguj się do <a href="https://aws.amazon.com/" rel="nofollow noopener noreferrer" target="_blank">panelu AWS</a> i przejdź do instancji EC2. Z pionowego menu po lewej stronie wybierz opcję "<strong>Volumes"</strong> z kategorii <strong>"Elastic Block Store"</strong>. Utwórz nowy wolumen poprzez niebieski przycisk <strong>"Create Volume"</strong>. W formularzu zmieniamy wielkość wolumenu na mniejszą wartość, 8GB w zupełności wystarczy nam jako SWAP. Upewnij się że tworzony wolumen jest w tej samej strefie co istniejąca instancja EC2, w moim przypadku jest to eu-central-1b. Zapisujemy uzupełniony formularz i przechodzimy do drugiego kroku.
<img alt="aws_2.png" src="/blog/images/articles/ec2-swap/aws_2.png"></p>
<h2 id="krok-2-przypisz-wolumen-do-instancji"><a href="#krok-2-przypisz-wolumen-do-instancji" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Krok 2. Przypisz wolumen do instancji</h2>
<p>Po zapisaniu formularza zostaniemy przekierowani na listę wolumenów. Klikając prawym przyciskiem myszy na utworzony wolumen wywołaj menu kontekstowe i wybierz <strong>"Attach Volume"</strong>.</p>
<p><img alt="aws_3.png" src="/blog/images/articles/ec2-swap/aws_3.png"></p>
<p>Z pola dot. instancji wybierz tę, do której chcesz przypisać wolumen.</p>
<p><img alt="aws_4.png" src="/blog/images/articles/ec2-swap/aws_4.png"></p>
<p>W momencie pomyślnego przypisania, p
artycja powinna być dostępna bez restartu instancji. Można to sprawdzić za pomocą komendy <code>lsblk</code> w terminalu.</p>
<p><img alt="swap_1.png" src="/blog/images/articles/ec2-swap/swap_1.png"></p>
<h2 id="krok-3-utwórz-partycję-swap"><a href="#krok-3-utw%C3%B3rz-partycj%C4%99-swap" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Krok 3. Utwórz partycję SWAP</h2>
<p>Utwórz swap file o wielkości wolumenu za pomocą komendy</p>
<p><code>sudo dd if=/dev/zero of=/dev/xvdc bs=1M count=8192</code></p>
<p>W miejscu <code>/dev/xvdc</code> wstaw nazwę partycji, którą wskazuje Twoja instancja z listy <code>lsblk</code> .</p>
<p>Ustaw właściciela oraz odpowiednie uprawnienia dla partycji:</p>
<p><code>sudo chown root:root /dev/xvdc</code></p>
<p><code>sudo chmod 600 /dev/xvdc</code></p>
<p>Stwórz i oflaguj obszar wymiany</p>
<p><code>sudo mkswap /dev/xvdc</code></p>
<p><code>sudo swapon /dev/xvdc</code></p>
<p>Dodaj poniższą linijkę do <code>/etc/fstab</code> komendą <code>sudo nano /etc/fstab</code></p>
<p><code>/dev/xvdc swap swap defaults 0 0</code></p>
<p>Jak zapiszesz i wyjdziesz z edytora, pozostaje tylko włączenie swap'u wpisując:</p>
<p><code>sudo swapon -a</code></p>
<p>Aby sprawdzić czy poprawnie utworzyliśmy partycję SWAP wystarczy że wpiszemy ponownie lsblk i zobaczymy oznaczenie [SWAP] obok naszej partycji.</p>
<p><img alt="swap_5.png" src="/blog/images/articles/ec2-swap/swap_2.png"></p>
<h2 id="krok-4-popraw-skrypt-buildu"><a href="#krok-4-popraw-skrypt-buildu" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Krok 4. Popraw skrypt build'u</h2>
<p>Aby Node.js mógł użyć większej ilości pamięci trzeba mu to przekazać za pomocą opcji <code>max-old-space-size</code>. Z dokumentacji oraz z wpisów innych developerów można wywnioskować kilka sposobów zastosowania tego ustawienia. Dokumentacja wskazuje na dodanie flagi podczas uruchamiania pliku, przykładowo:</p>
<p><code>node --max-old-space-size=8192 index.js</code></p>
<p>natomiast odpowiedzi na StackOverflow sugerują wprowadzenie do terminalu komendy</p>
<p><code>NODE_OPTIONS=--max-old-space-size=8192</code></p>
<p>i dopiero spróbować uruchomić kompilacje projektu.</p>
<p>Jeśli żadna z tych dwóch komend nie zadziała, spróbuj zawrzeć ustawienie tej opcji w skrypcie kompilacji w pliku <code>package.json</code>.</p>
<div class="nuxt-content-highlight"><pre class="language-json line-numbers"><code><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">"production"</span><span class="token operator">:</span> <span class="token string">"NODE_OPTIONS=\"--max-old-space-size=8192\" mix --production"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div>
<p>Dopiero ta metoda u mnie <em>'zaskoczyła'</em> i dzięki temu mogłem dokonać produkcyjnego build'u aplikacji bez żadnych błędów. Jak widać na obrazku poniżej.</p>
<p><img alt="compiled.png" src="/blog/images/articles/ec2-swap/compiled.png"></p></div></div></div></div> <div class="flex justify-between w-full py-4 px-4 md:px-0 container"><div><span class="text-gray-400">© 2021</span> <span>Sebastian Zborowski</span></div> <div><a href="mailto:sebastianzborowski99@gmail.com" class="text-indigo-600 dark:text-indigo-400">Email</a> <span class="dark:text-gray-200 text-gray-400 mx-2">/</span> <a href="https://github.com/zboru" target="_blank" class="text-indigo-600 dark:text-indigo-400">GitHub</a></div></div></div></div></div><script defer src="/blog/_nuxt/static/1635189324/aws-ec2/state.js"></script><script src="/blog/_nuxt/d3eef40.js" defer></script><script src="/blog/_nuxt/f12c784.js" defer></script><script src="/blog/_nuxt/500acbd.js" defer></script><script src="/blog/_nuxt/145e282.js" defer></script><script src="/blog/_nuxt/8282d77.js" defer></script>
  </body>
</html>
